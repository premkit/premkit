machine:
  services:
    - docker
  environment:
    GOPATH: $HOME
    PREMKIT_TAG: $(echo $CIRCLE_SHA1 | cut -c -7)

checkout:
  post:
    - mkdir -p $HOME/src/github.com/premkit
    - cp -r $HOME/premkit $HOME/src/github.com/premkit/premkit

dependencies:
  cache_directories:
    - $HOME/pkg
  pre:
    - go get golang.org/x/tools/cmd/cover
    - go get github.com/axw/gocov/gocov
    - go get github.com/go-swagger/go-swagger/cmd/swagger
    - go get github.com/mattn/goveralls
    - go get github.com/go-playground/overalls
    - make docker_build:
      pwd:
        $HOME/src/github.com/premkit/premkit
  override:
    - |
      docker run --rm \
        -v $HOME/src/github.com/premkit/premkit:/go/src/github.com/premkit/premkit \
        premkit/premkit:build \
        make build
    - make swagger-spec:
      pwd:
        $HOME/src/github.com/premkit/premkit
  post:
    - cp $HOME/src/github.com/premkit/premkit/bin/premkit $CIRCLE_ARTIFACTS
        

test:
  override:
    - overalls -project=github.com/premkit/premkit -covermode=count -ignore=vendor,integration -- -v
  post:
    - goveralls -service=circle-ci -repotoken=${COVERALLS_REPO_TOKEN} -coverprofile=$HOME/src/github.com/premkit/premkit/overalls.coverprofile

deployment:
  docker:
    branch: master
    owner: premkit
    commands:
      - |
        docker run --rm \
          -v $HOME/src/github.com/premkit/premkit:/go/src/github.com/premkit/premkit \
          premkit/premkit:build \
          make build_docker
      - cd $HOME/src/github.com/premkit/premkit && make package_docker
      - sudo docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - sudo docker tag -f premkit/premkit:$PREMKIT_TAG premkit/premkit:latest
      - sudo docker push premkit/premkit:$PREMKIT_TAG
