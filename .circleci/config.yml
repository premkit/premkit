version: 2.1

orbs:
  anchore: anchore/anchore-engine@1

default_env: &default_env
  PROJECT_NAME: premkit


docker_build: &docker_build
  docker:
    - image: circleci/golang:1.16
  working_directory: /go/src/github.com/premkit/premkit
  environment:
    <<: *default_env


jobs:

  build:
    <<: *docker_build
    steps:
      - checkout
      - run:
          name: Build Premkit
          command: |
            export BUILD_SHA=${CIRCLE_SHA1:0:7}
            export BUILD_VERSION=${CIRCLE_TAG//v}
            sudo -E PATH=$PATH make build
            sudo chown -R circleci:circleci /home/circleci/.cache/
      - persist_to_workspace:
          root: .
          paths:
            - bin

  test:
    <<: *docker_build
    steps:
      - checkout
      - run:
          name: Run go tests
          command: |
            make test

  spec:
    <<: *docker_build
    steps:
      - checkout
      - run:
          name: Build Swagger Spec
          command: |
            go get github.com/go-swagger/go-swagger/cmd/swagger
            make swagger_spec
      - persist_to_workspace:
          root: .
          paths:
            - spec

  push:
    executor: anchore/anchore_engine
    steps:
      - checkout
      - setup_remote_docker
      - attach_workspace:
          at: .
      - run:
          name: Build image
          command: |
            docker build --pull -t registry.replicated.com/library/premkit:local -f ./deploy/Dockerfile .
      - anchore/analyze_local_image:
          dockerfile_path: ./deploy/Dockerfile
          image_name: registry.replicated.com/library/premkit:local
          policy_bundle_file_path: .circleci/.anchore/policy_bundle.json
          policy_failure: true
          timeout: '500'
      - anchore/parse_reports
      - store_artifacts:
          path: anchore-reports
      - deploy:
          name: Push the image
          command: |
            docker login -u $LIBRARY_TOKEN -p $LIBRARY_PASSWORD registry.replicated.com
            docker tag registry.replicated.com/library/premkit:local registry.replicated.com/library/premkit:$CIRCLE_TAG
            docker push registry.replicated.com/library/premkit:$CIRCLE_TAG

  local_image_scan:
    executor: anchore/anchore_engine
    steps:
      - checkout
      - setup_remote_docker
      - attach_workspace:
          at: .
      - run:
          name: Build image
          command: |
            docker build --pull -t registry.replicated.com/library/premkit:local -f ./deploy/Dockerfile .
      - anchore/analyze_local_image:
          dockerfile_path: ./deploy/Dockerfile
          image_name: registry.replicated.com/library/premkit:local
          policy_bundle_file_path: .circleci/.anchore/policy_bundle.json
          policy_failure: true
          timeout: '500'
      - anchore/parse_reports
      - store_artifacts:
          path: anchore-reports

workflows:
  version: 2

  pull_request:
    jobs:
      - build:
          filters:
            branches:
              ignore: master
      - test:
          filters:
            branches:
              ignore: master
      - spec:
          filters:
            branches:
              ignore: master
      - local_image_scan:
          requires:
            - build
          filters:
            branches:
              ignore: master

  deploy:
    jobs:
      - build:
          filters:
            tags:
              only: /^v[0-9]+(\.[0-9]+)*(-.*)*/
            branches:
              ignore: /.*/
      - test:
          filters:
            tags:
              only: /^v[0-9]+(\.[0-9]+)*(-.*)*/
            branches:
              ignore: /.*/
      - spec:
          filters:
            tags:
              only: /^v[0-9]+(\.[0-9]+)*(-.*)*/
            branches:
              ignore: /.*/
      - local_image_scan:
          requires:
            - build
          filters:
            tags:
              only: /^v[0-9]+(\.[0-9]+)*(-.*)*/
            branches:
              ignore: /.*/
      - push:
          requires:
            - build
            - test
            - spec
            - local_image_scan
          filters:
            tags:
              only: /^v[0-9]+(\.[0-9]+)*(-.*)*/
            branches:
              ignore: /.*/
